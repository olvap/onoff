<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <style type="text/css">
          .red-bg {
            background-color: #ed5565;
            color: #ffffff;
          }
          .blue-bg {
            background-color: #204D74;
            color: #ffffff;
          }
          .widget {
            border-radius: 5px;
            margin-bottom: 10px;
            margin-top: 10px;
            padding: 15px 20px;
            width: 400px;
            float: left;
          }
          .navy-bg {
            background-color: #1ab394;
            color: #ffffff;
          }
        </style>

    </head>
    <body>
        <h1>Console</h2>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('vibration', 0)">Vibration 0</button>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('vibration', 1)">Vibration 1</button>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('vibration', 2)">Vibration 2</button>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('vibration', 3)">Vibration 3</button>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('wet', 1)">Wet On</button>
        <button type="button" class="btn btn-lg btn-danger" onclick="message('wet', 0)">Wet Off</button>
        <button type="button" class="btn btn-lg btn-primary" onclick="message('fan', 1)">Fan On</button>
        <button type="button" class="btn btn-lg btn-danger" onclick="message('fan', 0)">Fan Off</button>

        <h2>Admin</h2>
        <h3>Vibration Level</h3>
        <div class="progress">
          <div id="vibration_level" class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
            <span class="sr-only"></span>
          </div>
        </div>
        <div class="widget navy-bg text-center">
          <h3>Fan</h3>
          <i id="fan" class="fa fa-gear fa-4x fa-spin"></i>
        </div>
        <div id="wet" class="widget red-bg p-lg text-center">
          <i class="fa fa-bell fa-4x"></i>
          <h3>Water detected</h3>
        </div>

        <script src="js/mqttws31.js"></script>
        <script>
          var credentials = {
            user_name: '17b9217e-432a-4bf2-a46d-55e65b6ab11c',
            password: '8fYIbLqjRCQEvozKy3GoEg==',
            host: 'broker.xively.com',
            port: 443,
            status: 'xi/blue/v1/db133d3d-28a8-4fb0-aa6f-492dbbc1f41b/d/a68fb6dc-2ca2-405a-9495-8a57afc0628a/status',
            actuators: 'xi/blue/v1/db133d3d-28a8-4fb0-aa6f-492dbbc1f41b/d/a68fb6dc-2ca2-405a-9495-8a57afc0628a/actuators'
          }

          var command = {

            vibration: function(value) {
              document.getElementById('vibration_level').style.width = value /3 *100 + "%";
            },

            wet: function(value){
              var wet = document.getElementById('wet');
              if(value=='0'){
                wet.classList.remove("red-bg");
                wet.classList.add("blue-bg");
                wet.children[1].innerHTML = 'All Dry';
              } else {
                wet.classList.add("red-bg");
                wet.classList.remove("blue-bg");
                wet.children[1].innerHTML = 'Water detected';
              }
            },

            fan: function(value){
              var fan = document.getElementById('fan')
              if(value == '0'){
                fan.classList.remove("fa-spin")
              } else{
                fan.classList.add("fa-spin")
              }
            }
          };

          // Create a client instance
          var client = new Paho.MQTT.Client(credentials['host'], credentials['port'], credentials['user_name']);

          // set callback handlers
          client.onConnectionLost = onConnectionLost;
          client.onMessageArrived = onMessageArrived;

          // connect the client
          client.connect({ userName: credentials['user_name'],
                           password: credentials['password'],
                           useSSL: true,
                           onFailure: function(){ console.log('error'); },
                           onSuccess:onConnect });

          // called when the client connects
          function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            console.log("onConnect");
            client.subscribe(credentials['status']);
          }

          // called when the client loses its connection
          function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
              console.log("onConnectionLost:"+responseObject.errorMessage);
            }
          }

          // called when a message arrives
          function onMessageArrived(message) {
            msg = JSON.parse(message.payloadString);
            console.log(msg);
            command[msg["command"]](msg["value"]);
          }

          function message(command, value){
            msg = new Paho.MQTT.Message('{ "command":"' + command + '", "value":"' + value + '"}');
            msg.destinationName = credentials['status'];
            client.send(msg);
          }
        </script>

    </body>
</html>
